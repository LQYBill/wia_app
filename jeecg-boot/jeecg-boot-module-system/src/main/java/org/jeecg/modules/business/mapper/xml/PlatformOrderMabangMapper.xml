<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.business.mapper.PlatformOrderMabangMapper">

    <update id="updateMergedOrder">
        UPDATE platform_order
        SET target = #{target}
        WHERE platform_order_id IN
        <foreach
                collection="sources"
                separator=","
                index="i"
                item="v"
                open="("
                close=")">
            #{v}
        </foreach>;
    </update>

    <update id="updateMergedOrderItems">
        UPDATE platform_order_content
        SET platform_order_id = #{target}
        WHERE platform_order_id IN
        <foreach
                collection="sources"
                separator=","
                index="i"
                item="v"
                open="("
                close=")">
            #{v}
        </foreach>
    </update>


    <select id="findIdByErpCode" resultType="java.lang.String">
        SELECT id
        FROM platform_order
        WHERE platform_order_number = #{1}
    </select>

    <select id="findIdByErpId" resultType="java.lang.String">
        SELECT id
        FROM platform_order
        WHERE erp_order_id = #{1}
    </select>

    <insert id="insertOrderFromMabang">
        INSERT INTO platform_order(id, create_by, create_time, update_by,
                                   update_time, shop_id, logistic_channel_name,
                                   platform_order_id, platform_order_number, erp_order_id,
                                   tracking_number, order_time, shipping_time, recipient,
                                   country, postcode, status)
        SELECT #{order.id},
               'mabang api',
               NOW(),
               'mabang api',
               NOW(),
               id,
               #{order.logisticChannelName},
               #{order.platformOrderId},
               #{order.platformOrderNumber},
               #{order.erpOrderId},
               #{order.trackingNumber},
               #{order.orderTime},
               #{order.shippingTime},
               #{order.recipient},
               #{order.country},
               #{order.postcode},
               #{order.status}
        FROM shop
        WHERE erp_code = #{order.shopErpCode};
    </insert>

    <insert id="insertOrderItemsFromMabang">
        INSERT INTO platform_order_content(id, create_by, create_time,
                                           update_by, update_time, platform_order_id, sku_id, quantity)
        SELECT UUID(),
               'admin',
               NOW(),
               'admin',
               NOW(),
               #{mainId},
               sku.id,
               #{item.quantity}
        FROM sku
        WHERE erp_code = #{item.erpCode}
    </insert>

</mapper>
